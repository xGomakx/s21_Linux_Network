## №1. Инструмент ipcalc
### Сети и маски
1.
``` brew
Адрес сети 192.167.38.54/13
```
![](./1.1.png)
2.
``` brew
Перевод маски 255.255.255.0 в префиксную и двоичную запись
```
![](./1.2.png)
``` brew
/15 в обычную и двоичную
```
![](./1.3.png)
``` brew
11111111.11111111.11111111.11110000 в обычную и префиксную
```
![](./1.4.png)
3.
``` brew
Минимальный и максимальный хост в сети 12.167.38.4 при маске /8
```
![](./1.5.png)
``` brew
Минимальный и максимальный хост в сети 12.167.38.4 при маске 11111111.11111111.00000000.00000000
```
![](./1.6.png)
``` brew
Минимальный и максимальный хост в сети 12.167.38.4 при маске 255.255.254.0
```
![](./1.7.png)
``` brew
Минимальный и максимальный хост в сети 12.167.38.4 при маске /4
```
![](./1.8.png)
### localhost
1. Определить и записать в отчёт, можно ли обратиться к приложению, работающему на localhost, со следующими IP: 194.34.23.100, 127.0.0.2, 127.1.0.1, 128.0.0.1
``` brew
* Можно:      
127.1.0.1;    
128.0.0.1. 
* Нельзя:          
194.34.23.100;           
128.0.0.1.
```
### Диапазоны и сегменты сетей
Определить и записать в отчёт:
1. какие из перечисленных IP можно использовать в качестве публичного, а какие только в качестве частных: 10.0.0.45, 134.43.0.2, 192.168.4.2, 172.20.250.4, 172.0.2.1, 192.172.0.1, 172.68.0.2, 172.16.255.255, 10.10.10.10, 192.169.168.1
``` brew
* В качестве публичного: 134.43.0.2, 172.0.2.1, 192.172.0.1, 172.68.0.2, 192.169.168.1.
* В качестве чаcтных: 10.0.0.45, 192.168.4.2, 172.20.250.4, 172.16.255.255, 10.10.10.10.
```
2. какие из перечисленных IP адресов шлюза возможны у сети 10.10.0.0/18: 10.0.0.1, 10.10.0.2, 10.10.10.10, 10.10.100.1, 10.10.1.255
``` brew
* Возможны: 10.10.0.2, 10.10.10.10, 10.10.1.255
* Невозможны: 10.0.0.1, 10.10.100.1.
```
## №2. Статическая маршрутизация между двумя машинами
#### Поднять две виртуальные машины (далее -- ws1 и ws2)
#### С помощью команды ip a посмотреть существующие сетевые интерфейсы
![](./2.1.png)
![](./2.2.png)
1. lo или local loopback (локальная петля). Служит для подключения по сети к этому же компьютеру и не требует дополнительной настройки;
``` brew
* ws1: 127.0.0.1/8;
* ws2: 127.0.0.1/8;
```
2. enp0s3 - первый сетевой адаптер работающий в NAT режиме. 
``` brew
* ws1: 10.0.2.15/24;
* ws2: 10.0.2.15/24.
```
#### Описать сетевой интерфейс, соответствующий внутренней сети, на обеих машинах и задать следующие адреса и маски: 
``` brew 
ws1 - 192.168.100.10, маска /16,
ws2 - 172.24.116.8, маска /12           
sudo vim /etc/netplan/00-installer-config.yaml
```
#### Выполнить команду netplan apply для перезапуска сервиса сети
``` brew 
netplan apply
```
![](./2.3.png)
![](./2.4.png)
### Добавление статического маршрута вручную
#### Добавить статический маршрут от одной машины до другой и обратно при помощи команды вида ip r add
``` brew 
sudo ip r add 172.24.116.8 dev enp0s3//ws1
sudo ip r add 192.168.100.10 dev enp0s3//ws2
```
#### Пропинговать соединение между машинами
``` brew
ping 172.24.116.8 //ws1
ping 192.168.100.10 //ws2
```
![](./2.5.png)
![](./2.6.png)
### Добавление статического маршрута с сохранением
#### Перезапустить машины
``` brew 
sudo netplan apply
```
#### Добавить статический маршрут от одной машины до другой с помощью файла etc/netplan/00-installer-config.yaml
``` brew
sudo vim /etc/netplan/00-installer-config.yaml
```
#### Пропинговать соединение между машинами
![](./2.7.png)
![](./2.8.png)
## №3. Утилита iperf3
### Скорость соединения
Перевести и записать в отчёт: 8 Mbps в MB/s, 100 MB/s в Kbps, 1 Gbps в Mbps
``` brew
8Mbps == 1MB/s;
100MB/s == 819200 Kbps;
1Gbps == 1024 Mbps.
``` 
### Утилита iperf3
Измерить скорость соединения между ws1 и ws2
![](./2.9.png)
![](./2.10.png)
## №4. Сетевой экран
### Утилита iptables
Создать файл /etc/firewall.sh, имитирующий фаерволл, на ws1 и ws2.
Нужно добавить в файл подряд следующие правила:

1) на ws1 применить стратегию когда в начале пишется запрещающее правило, а в конце пишется разрешающее правило (это касается пунктов 4 и 5)

2) на ws2 применить стратегию когда в начале пишется разрешающее правило, а в конце пишется запрещающее правило (это касается пунктов 4 и 5)

3) открыть на машинах доступ для порта 22 (ssh) и порта 80 (http)

4) запретить echo reply (машина не должна "пинговаться”, т.е. должна быть блокировка на OUTPUT)

5) разрешить echo reply (машина должна "пинговаться")

![](./2.11.png)
![](./2.12.png)
Запустить файлы на обеих машинах командами chmod +x /etc/firewall.sh и /etc/firewall.sh
![](./2.13.png)
![](./2.14.png)
``` brew
Правила выполняться сверху-вниз, следовательно, если правило запрета находиться выше оно срабатывает, а правило разрешения находящиеся ниже нет. Следовательно 1ая машина не пингуется, а 2ая пингуется.
```
### Утилита nmap
Командой ping найти машину, которая не "пингуется", после чего утилитой nmap показать, что хост машины запущен
![](./2.15.png)
![](./2.16.png)
``` brew
Видно из скрина что, хост 1ой машины запущен, но не пингуется
```
## №5. Статическая маршрутизация сети
Поднять пять виртуальных машин (3 рабочие станции (ws11, ws21, ws22) и 2 роутера (r1, r2))
![](./5.0.png)
### Настройка адресов машин
Настроить конфигурации машин в etc/netplan/00-installer-config.yaml согласно сети на рисунке.
![](./5.1.png)
![](./5.2.png)
![](./5.3.png)
![](./5.4.png)
![](./5.5.png)

Перезапустить сервис сети. Если ошибок нет, то командой ip -4 a проверить, что адрес машины задан верно. Также пропинговать ws22 с ws21. Аналогично пропинговать r1 с ws11.
``` brew
ip -4 a
```
![](./5.6.png)
![](./5.7.png)
![](./5.8.png)
![](./5.9.png)
![](./5.10.png)
``` brew
пропинговать ws22 с ws21
```
![](./5.11.png)
``` brew
пропинговать r1 с ws11
```
![](./5.12.png)
### Включение переадресации IP-адресов.
Для включения переадресации IP, выполните команду на роутерах:
``` brew
sysctl -w net.ipv4.ip_forward=1
```
![](./5.13.png)
![](./5.14.png)

Откройте файл /etc/sysctl.conf и добавьте в него следующую строку:
``` brew
net.ipv4.ip_forward = 1
```
![](./5.15.png)
![](./5.16.png)
### Установка маршрута по-умолчанию
Настроить маршрут по-умолчанию (шлюз) для рабочих станций. Для этого добавить gateway4 [ip роутера] в файле конфигураций
Вызвать ip r и показать, что добавился маршрут в таблицу маршрутизации
``` brew
ip r
```
![](./5.17.png)
![](./5.18.png)
![](./5.19.png)

Пропинговать с ws11 роутер r2 и показать на r2, что пинг доходит. Для этого использовать команду:
``` brew
tcpdump -tn -i eth1
```
![](./5.20.png)
![](./5.21.png)
### Добавление статических маршрутов
Добавить в роутеры r1 и r2 статические маршруты в файле конфигураций.
![](./5.22.png)
![](./5.23.png)

Вызвать ip r и показать таблицы с маршрутами на обоих роутерах. Пример таблицы на r1:
``` brew
ip r
```
![](./5.24.png)
![](./5.25.png)

Запустить команды на ws11:
``` brew
ip r list 10.10.0.0/[18]
ip r list 0.0.0.0/0
```
![](./5.26.png)

Для адреса 10.10.0.0/18 был выбран маршрут, отличный от 0.0.0.0/0, поскольку он является адресом сети и доступен без шлюза.
### Построение списка маршрутизаторов
Запустить на r1 команду дампа
``` brew
tcpdump -tnv -i eth0
```
При помощи утилиты traceroute построить список маршрутизаторов на пути от ws11 до ws21
![](./5.27.png)
![](./5.28.png)

Команда traceroute отправляет UDP пакет с TTL=1(время жизни) и смотрит адрес ответившего узла,
дальше TTL=2, TTL=3 и так пока не достигнет цели. Каждый раз отправляется по три пакета
и для каждого из них измеряется время прохождения. Пакет отправляется на случайный порт, который,
скорее всего, не занят. Когда утилита traceroute получает сообщение от целевого узла о том,
что порт недоступен трассировка считается завершенной.
Мы нашли нужный узел с первого раза, так как у нас на роутере (r1 - он же шлюз по умолчанию)
прописан статический маршрут в нужную сеть.

Процесс повторяется до тех пор, пока пакет не достигнет целевого узла, тем самым увеличивая значение ttl. При получении ответа от этого узла процесс трассировки считается завершённым.
### Использование протокола ICMP при маршрутизации
Запустить на r1 перехват сетевого трафика, проходящего через eth0 с помощью команды:
``` brew
tcpdump -n -i eth0 icmp
```
Пропинговать с ws11 несуществующий IP (например, 10.30.0.111) с помощью команды:
``` brew
ping -c 1 10.30.0.111
```
![](./5.29.png)
![](./5.30.png)
## №6. Динамическая настройка IP с помощью DHCP
Для r2 настроить в файле /etc/dhcp/dhcpd.conf конфигурацию службы DHCP:
1) указать адрес маршрутизатора по-умолчанию, DNS-сервер и адрес внутренней сети. 
![](./6.1.png)
2) в файле resolv.conf прописать nameserver 8.8.8.8.

![](./6.2.png)

Перезагрузить службу DHCP командой systemctl restart isc-dhcp-server. Машину ws21 перезагрузить при помощи reboot и через ip a показать, что она получила адрес. Также пропинговать ws22 с ws21.
``` brew
systemctl restart isc-dhcp-server // r2
```
![](./6.3.png)
``` brew
reboot // ws21
ip a // ws 21
```
![](./6.4.png)

Указать MAC адрес у ws11, для этого в etc/netplan/00-installer-config.yaml надо добавить строки: macaddress: 10:10:10:10:10:BA, dhcp4: true

![](./6.5.png)

Для r1 настроить аналогично r2, но сделать выдачу адресов с жесткой привязкой к MAC-адресу (ws11). Провести аналогичные тесты
В файле /etc/dhcp/dhcpd.conf настроить конфигурацию службы DHCP с жесткой привязкой к MAC-адресу (ws11)

![](./6.6.png)

в файле resolv.conf прописать nameserver 8.8.8.8 (DNS)

![](./6.7.png)

Перезагрузить службу DHCP командой systemctl restart isc-dhcp-server. Машину ws11 перезагрузить при помощи reboot и через ip a показать, что она получила адрес.
``` brew
systemctl restart isc-dhcp-server // r1
```
![](./6.8.png)
``` brew
reboot // ws11
ip a // ws 11
```
![](./6.9.png)

Запросить с ws21 обновление ip адреса
В отчёте поместить скрины ip до и после обновления
``` brew
До обновления
``` 
![](./6.10.png)

Обновление с помощью следующих команд:
``` brew
sudo dhclient -r enp0s3
sudo dhclient enp0s3
```
``` brew
После обновления
``` 
![](./6.17.png)
## №7. NAT
В файле /etc/apache2/ports.conf на ws22 и r1 изменить строку Listen 80 на Listen 0.0.0.0:80, то есть сделать сервер Apache2 общедоступным
![](./7.1.png)
![](./7.2.png)

Запустить веб-сервер Apache командой service apache2 start на ws22 и r1

![](./7.3.png)
![](./7.5.png)

Добавить в фаервол, созданный по аналогии с фаерволом из Части 4, на r2 следующие правила:

1) Удаление правил в таблице filter - iptables -F


2) Удаление правил в таблице "NAT" - iptables -F -t nat


3) Отбрасывать все маршрутизируемые пакеты - iptables --policy FORWARD DROP

![](./7.6.png)

Запускать файл также, как в Части 4

Проверить соединение между ws22 и r1 командой ping

При запуске файла с этими правилами, ws22 не должна "пинговаться" с r1

![](./7.7.png)

Добавить в файл ещё одно правило:

4) Разрешить маршрутизацию всех пакетов протокола ICMP
![](./7.8.png)
Запускать файл также, как в Части 4

Проверить соединение между ws22 и r1 командой ping

При запуске файла с этими правилами, ws22 должна "пинговаться" с r1

![](./7.9.png)

Добавить в файл ещё два правила:

5) Включить SNAT, а именно маскирование всех локальных ip из локальной сети, находящейся за r2 (по обозначениям из Части 5 - сеть 10.20.0.0)
6) Включить DNAT на 8080 порт машины r2 и добавить к веб-серверу Apache, запущенному на ws22, доступ извне сети
7) Включить DNAT на 8080 порт машины r2 и добавить к веб-серверу Apache, запущенному на ws22, доступ извне сети

![](./7.10.png)

Проверить соединение по TCP для SNAT, для этого с ws22 подключиться к серверу Apache на r1 командой:
``` brew
telnet 10.100.0.11 80
```
![](./7.11.png)

Проверить соединение по TCP для DNAT, для этого с r1 подключиться к серверу Apache на ws22 командой telnet (обращаться по адресу r2 и порту 8080)
``` brew
telnet 10.100.0.12 8080
```
![](./7.12.png)

## №8.  Дополнительно. Знакомство с SSH Tunnels
Запустить на r2 фаервол с правилами из Части 7

![](./7.10.png)

Запустить веб-сервер Apache на ws22 только на localhost (то есть в файле /etc/apache2/ports.conf изменить строку Listen 80 на Listen localhost:80)

![](./8.1.png)
![](./8.2.png)

Воспользоваться Local TCP forwarding с ws21 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws21

![](./8.4.png)

Воспользоваться Remote TCP forwarding c ws11 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws11

![](./8.5.png)

Для проверки, сработало ли подключение в обоих предыдущих пунктах, перейдите во второй терминал (например, клавишами Alt + F2) и выполните команду:
``` brew
telnet 127.0.0.1 [локальный порт]
```
![](./8.6.png)
